# API Gateway 프로젝트 문서

## 목차
1. [프로젝트 개요](#프로젝트-개요)
2. [프로젝트 구조](#프로젝트-구조)
3. [데이터 흐름](#데이터-흐름)
4. [주요 기능](#주요-기능)
5. [설정 방법](#설정-방법)
6. [개발 환경](#개발-환경)
7. [참고 사항](#참고-사항)


## 프로젝트 개요

이 프로젝트는 다양한 백엔드 마이크로서비스로 HTTP/WebSocket 요청을 라우팅하는 고성능 API Gateway입니다. 마이크로서비스 아키텍처에서 단일 진입점(entry point) 역할을 하며, 트래픽 관리, 보안, 모니터링 등 다양한 기능을 제공합니다.


### API Gateway의 주요 역할

1. **중앙 집중식 라우팅**: 모든 클라이언트 요청을 적절한 서비스로 라우팅
2. **인증 및 인가**: JWT 기반 인증으로 보안 관리
3. **부하 분산**: 여러 백엔드 인스턴스 간 트래픽 분산
4. **장애 복구**: 서킷 브레이커 패턴으로 시스템 안정성 확보
5. **모니터링 및 로깅**: 시스템 상태 추적을 위한 메트릭 수집
6. **캐싱**: 응답 캐싱으로 성능 향상 및 백엔드 부하 감소
7. **속도 제한**: 과도한 요청으로부터 API 보호

## 프로젝트 구조

프로젝트는 Go 언어로 작성되어 있으며, 모듈식 구조를 채택하여 코드의 가독성과 유지보수성을 높였습니다.

### 디렉토리 구조

```
api-gateway/
├── cmd/
│   └── gateway/
│       └── main.go          # 애플리케이션 진입점
├── configs/
│   ├── grafana/             # Grafana 대시보드 설정
│   ├── prometheus.yml       # Prometheus 설정
│   └── routes.json          # API 라우팅 설정
├── internal/
│   ├── auth/                # 인증 관련 코드
│   ├── config/              # 설정 로드 및 관리
│   ├── handler/             # 라우트 핸들러
│   ├── metrics/             # 메트릭 수집 
│   ├── middleware/          # HTTP 미들웨어
│   └── proxy/               # 리버스 프록시 구현
├── pkg/
│   ├── cache/               # 캐싱 시스템
│   ├── circuitbreaker/      # 서킷 브레이커 구현
│   ├── loadbalancer/        # 부하 분산 알고리즘
│   └── ratelimiter/         # 속도 제한 구현
├── scripts/                 # 빌드 및 배포 스크립트
├── tests/                   # 테스트 코드
│   ├── unit/                # 단위 테스트
│   ├── integration/         # 통합 테스트
│   └── mocks/               # 테스트 목업
├── docker-compose.yml       # 도커 컴포즈 설정
├── Dockerfile               # 도커 이미지 빌드 설정
├── go.mod                   # Go 모듈 정의
└── go.sum                   # Go 모듈 체크섬
```

### 주요 패키지 설명

1. **cmd/gateway**: 애플리케이션의 진입점으로, 모든 컴포넌트를 초기화하고 HTTP 서버를 실행합니다.

2. **internal/config**: 환경 변수나 설정 파일에서 애플리케이션 설정을 로드하는 기능을 제공합니다.

3. **internal/auth**: 인증 및 인가 관련 로직을 구현합니다. JWT 토큰 검증과 생성을 담당합니다.

4. **internal/handler**: API 라우트 처리를 담당하는 핸들러입니다.

5. **internal/middleware**: HTTP 요청 처리 전후에 실행되는 미들웨어 기능을 제공합니다.
   - 로깅, CORS, 인증, 속도 제한, 요청 크기 제한 등

6. **internal/proxy**: 리버스 프록시 기능을 구현하여 요청을 백엔드 서비스로 전달합니다.

7. **pkg/cache**: 응답 캐싱 메커니즘을 제공합니다.

8. **pkg/circuitbreaker**: 서킷 브레이커 패턴을 구현하여 장애 백엔드 서비스로부터 시스템을 보호합니다.

9. **pkg/loadbalancer**: 여러 백엔드 인스턴스 간에 요청을 분산하는 부하 분산 알고리즘을 제공합니다.

10. **pkg/ratelimiter**: 과도한 요청으로부터 API를 보호하는 속도 제한 기능을 구현합니다.

## 데이터 흐름

API Gateway를 통한 요청 처리 흐름은 다음과 같습니다:

1. 클라이언트가 API Gateway로 HTTP/WebSocket 요청을 보냅니다.
2. 요청은 미들웨어 체인을 통과합니다:
   - 로깅 미들웨어가 요청을 기록합니다.
   - CORS 미들웨어가 크로스 오리진 요청을 처리합니다.
   - 속도 제한 미들웨어가 과도한 요청을 제한합니다.
   - 요청 크기 제한 미들웨어가 대용량 요청을 차단합니다.
   - 인증 미들웨어가 JWT 토큰을 검증합니다(필요한 경우).
   - 메트릭 미들웨어가 요청 메트릭을 수집합니다.
3. 라우트 핸들러가 요청을 처리할 적절한 백엔드 서비스를 결정합니다.
4. 캐시가 확인되고, 캐시 히트가 있으면 캐시된 응답을 반환합니다.
5. 서킷 브레이커가 백엔드 서비스 상태를 확인합니다:
   - 서킷이 열려 있으면(장애 상태) 실패 응답을 반환합니다.
   - 서킷이 닫혀 있거나 반열림 상태이면 요청을 계속 처리합니다.
6. 부하 분산기가 여러 백엔드 인스턴스 중 하나를 선택합니다.
7. 리버스 프록시가 요청을 선택된 백엔드로 전달합니다.
8. 응답이 다시 클라이언트로 전송되기 전에 필요에 따라 캐시됩니다.
9. 서킷 브레이커에 응답 결과(성공/실패)가 기록됩니다.
10. 메트릭이 업데이트되고 응답이 로깅됩니다.

## 주요 기능

### 1. 동적 라우팅

API Gateway는 `configs/routes.json` 파일에 정의된 경로 패턴에 따라 요청을 다양한 백엔드 서비스로 라우팅합니다. 각 라우트는 경로 패턴, 대상 URL, 허용된 HTTP 메서드, 인증 요구 사항 등을 지정할 수 있습니다.

```json
{
  "routes": [
    {
      "path": "/api/users/*path",
      "targetURL": "http://localhost:8081",
      "methods": ["GET", "POST", "PUT", "DELETE"],
      "requireAuth": true,
      "stripPrefix": "/api/users"
    }
  ]
}
```

### 2. 인증 및 인가

JWT(JSON Web Token) 기반 인증을 지원하여 보호된 엔드포인트에 대한 접근을 제어합니다. 토큰은 비밀 키로 서명되며, 발행자 및 만료 시간을 설정할 수 있습니다.

### 3. 부하 분산

여러 백엔드 인스턴스 간에 요청을 분산하는 부하 분산 기능을 제공합니다. 현재는 라운드 로빈 알고리즘이 구현되어 있으며, 필요에 따라 가중치 기반 또는 최소 연결 알고리즘도 추가할 수 있습니다.

### 4. 서킷 브레이커

서킷 브레이커 패턴을 구현하여 장애가 있는 백엔드 서비스로부터 시스템을 보호합니다. 연속된 오류가 임계값을 초과하면 서킷이 열리고(오픈), 일정 시간 동안 요청이 차단됩니다. 그 후 서킷은 반열림 상태로 전환되어 제한된 요청을 허용하고, 성공하면 다시 정상 상태로 돌아갑니다.

### 5. 캐싱

자주 액세스하는 응답을 캐싱하여 성능을 향상시키고 백엔드 부하를 줄입니다. 캐시 TTL(Time To Live)은 전역 또는 라우트별로 설정할 수 있습니다.

### 6. 속도 제한

클라이언트 IP 또는 API 키를 기반으로 속도 제한을 적용하여 과도한 요청으로부터 API를 보호합니다. 슬라이딩 윈도우 알고리즘을 사용하여 특정 기간 동안 허용되는 최대 요청 수를 제한합니다.

### 7. WebSocket 지원

API Gateway는 WebSocket 연결을 백엔드 서비스로 프록시하여 실시간 양방향 통신을 지원합니다.

### 8. 모니터링 및 로깅

Prometheus 메트릭 수집과 Grafana 대시보드를 통한 포괄적인 모니터링 시스템을 제공합니다. 구조화된 로깅을 사용하여 요청 및 응답 세부 정보를 로깅합니다.

## 설정 방법

### 환경 변수

API Gateway는 다음과 같은 환경 변수를 통해 구성할 수 있습니다:

| 환경 변수 | 기본값 | 설명 |
|-----------|---------|-------------|
| PORT | 8080 | API Gateway 리스닝 포트 |
| BACKEND_URL | http://localhost:8081 | 기본 백엔드 서버 URL |
| BACKEND_URLS | - | 쉼표로 구분된 여러 백엔드 서버 URL |
| JWT_SECRET | your-secret-key | JWT 토큰 검증 비밀 키 |
| JWT_ISSUER | api-gateway | JWT 토큰 발행자 |
| JWT_EXPIRATION | 3600 | JWT 토큰 만료 시간(초) |
| ALLOWED_ORIGINS | * | CORS 허용 오리진 (쉼표 구분) |
| ROUTES_CONFIG_PATH | configs/routes.json | 라우트 설정 파일 경로 |
| ENABLE_METRICS | true | Prometheus 메트릭 활성화 여부 |
| ENABLE_CACHING | true | 응답 캐싱 활성화 여부 |
| CACHE_TTL | 300 | 캐시 항목 기본 수명(초) |

추가 설정 옵션은 `.env.example` 파일을 참조하세요.

### 라우트 설정

라우트 설정은 `configs/routes.json` 파일에 정의됩니다. 각 라우트는 다음 속성을 가질 수 있습니다:

- `path`: 매칭할 경로 패턴 (예: `/api/users/*path`)
- `targetURL`: 요청을 전달할 대상 URL
- `methods`: 허용된 HTTP 메서드 목록
- `requireAuth`: JWT 인증 필요 여부
- `stripPrefix`: 대상으로 전달하기 전에 제거할 경로 접두사
- `cacheable`: 응답 캐싱 활성화 여부
- `timeout`: 요청 타임아웃(초)

## 개발 환경

### 로컬 개발

1. 저장소를 복제합니다:
   ```bash
   git clone https://github.com/yourusername/api-gateway.git
   cd api-gateway
   ```

2. 종속성을 설치합니다:
   ```bash
   go mod download
   ```

3. 환경 변수를 설정합니다:
   ```bash
   cp .env.example .env
   # 원하는 설정으로 .env 파일을 편집합니다
   ```

4. 애플리케이션을 빌드하고 실행합니다:
   ```bash
   make build
   ./build/api-gateway
   ```

5. 개발 모드에서 실행합니다(라이브 리로드 사용):
   ```bash
   make dev
   ```

### Docker로 실행

1. Docker 이미지를 빌드합니다:
   ```bash
   docker build -t api-gateway .
   ```

2. Docker 컨테이너를 실행합니다:
   ```bash
   docker run -p 8080:8080 api-gateway
   ```

3. Docker Compose로 전체 스택을 실행합니다:
   ```bash
   docker-compose up -d
   ```

## 참고 사항

### 상용 서비스에서 채택한 모범 사례

이 API Gateway 프로젝트는 다음과 같은 업계 모범 사례를 따릅니다:

1. **마이크로서비스 아키텍처**: Amazon API Gateway, Kong, NGINX 등과 같은 상용 API 게이트웨이는 마이크로서비스 아키텍처에서 단일 진입점으로 작동합니다.

2. **라우팅 및 트래픽 관리**: 상용 솔루션과 마찬가지로 동적 라우팅, 부하 분산, 서킷 브레이커 패턴을 구현하여 트래픽을 효과적으로 관리합니다.

3. **보안 기능**: JWT 기반 인증, 속도 제한, 요청 크기 제한 등의 보안 기능을 통해 API를 보호합니다.

4. **모니터링 및 관찰 가능성**: Prometheus 및 Grafana를 사용한 메트릭 수집, 구조화된 로깅을 통해 시스템 모니터링 및 문제 해결을 지원합니다.

5. **확장성**: 모듈식 설계와 컨테이너화 지원으로 시스템의 수평 확장이 가능합니다.

6. **신뢰성**: 서킷 브레이커, 타임아웃, 재시도 메커니즘을 통해 시스템 안정성을 확보합니다.

### 확장 및 개선 방향

향후 개발을 위한 몇 가지 제안 사항:

1. **OAuth 2.0 지원**: 보다 광범위한 인증 옵션을 위해 OAuth 2.0 지원 추가

2. **그래프QL 지원**: REST API 외에도 GraphQL 쿼리를 지원하는 기능 추가

3. **API 문서 통합**: Swagger/OpenAPI 문서화 도구 통합

4. **요청 변환**: 백엔드로 전달하기 전에 요청을 변환하는 기능 추가

5. **고급 부하 분산**: 최소 연결, 일관된 해싱 등 추가 부하 분산 알고리즘 구현

6. **서비스 검색 통합**: Consul, etcd 또는 Kubernetes와 같은 서비스 검색 메커니즘 통합

7. **gRPC 지원**: gRPC 프로토콜 지원 추가

8. **API 버전 관리**: API 버전 관리 및 하위 호환성 지원

9. **멀티 리전 지원**: 지리적으로 분산된 배포를 위한 멀티 리전 지원

## 결론

이 API Gateway 프로젝트는 마이크로서비스 아키텍처에서 API를 효율적으로 관리하기 위한 강력한 도구입니다. 다양한 기능과 확장 가능한 아키텍처를 제공하여 개발자가 보안, 성능 및 신뢰성을 유지하면서 백엔드 서비스를 쉽게 노출할 수 있도록 합니다.

프로젝트의 모듈식 설계는 새로운 기능을 쉽게 추가하고 기존 구성 요소를 필요에 따라 수정할 수 있도록 합니다. 다양한 미들웨어와 유틸리티를 통해 개발자는 커스터마이징된 API 게이트웨이 솔루션을 구축할 수 있습니다.